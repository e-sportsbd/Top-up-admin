<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Order Control – Admin</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
body{
    margin:0;
    background:#0d0d0d;
    color:white;
    font-family:'Poppins',sans-serif;
    padding:15px;
}

/* Header */
.header{
    background:#1e90ff;
    padding:15px;
    font-size:22px;
    font-weight:700;
    text-align:center;
    border-radius:12px;
    margin-bottom:15px;
}

/* Order Card */
.card{
    background:#1a1a1a;
    padding:15px;
    border-radius:12px;
    margin-bottom:15px;
    border:1px solid #333;
    box-shadow:0 0 10px rgba(0,0,0,0.25);
}

.row{ margin:6px 0; }
.key{ color:#7abaff; font-weight:600; }
.value{ font-weight:600; }

.status-btn{
    padding:8px 14px;
    border:none;
    border-radius:8px;
    margin-right:6px;
    margin-top:8px;
    font-weight:700;
    cursor:pointer;
}

.pending{ background:#ffae00; }
.success{ background:#00c853; }
.cancel{ background:#ff5252; }

.delete-btn{
    background:#ff1744;
    padding:8px 14px;
    border:none;
    border-radius:8px;
    color:white;
    font-weight:700;
    margin-top:10px;
    cursor:pointer;
    width:100%;
}
</style>
</head>

<body>

<div class="header">Order Control</div>

<div id="orderBox"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyBl0PIm4lvZea96Bte3KaKQJvurGE1P8Es",
  authDomain: "post-c7e41.firebaseapp.com",
  databaseURL: "https://post-c7e41-default-rtdb.firebaseio.com/",
  projectId: "post-c7e41",
  messagingSenderId: "758133068153",
  appId: "1:758133068153:web:5513a1de83491c81776084"
};
firebase.initializeApp(firebaseConfig);

const db = firebase.database();

// Load Orders
db.ref("orders").on("value", snap => {
    const box = document.getElementById("orderBox");
    box.innerHTML = "";

    snap.forEach(order => {
        let data = order.val();

        let div = document.createElement("div");
        div.className = "card";

        div.innerHTML = `
            <div class="row"><span class="key">Order ID:</span> <span class="value">${order.key}</span></div>
            <div class="row"><span class="key">User UID:</span> <span class="value">${data.uid}</span></div>
            <div class="row"><span class="key">Player ID:</span> <span class="value">${data.playerId}</span></div>
            <div class="row"><span class="key">Package:</span> <span class="value">${data.package.title}</span></div>
            <div class="row"><span class="key">Diamonds:</span> <span class="value">${data.package.diamonds}</span></div>
            <div class="row"><span class="key">Price:</span> <span class="value">${data.price}৳</span></div>
            <div class="row"><span class="key">Payment:</span> <span class="value">${data.payMethod}</span></div>
            <div class="row"><span class="key">Status:</span> <span class="value">${data.status}</span></div>
            <div class="row"><span class="key">Time:</span> <span class="value">${formatDate(data.time)}</span></div>

            <button class="status-btn pending" 
            onclick="updateStatus('${order.key}','Pending')">Pending</button>

            <button class="status-btn success" 
            onclick="markSuccess('${order.key}', '${data.uid}', '${data.playerId}', ${JSON.stringify(data.package).replace(/"/g,'&quot;')}, '${data.price}', '${data.payMethod}', '${data.time}')">Success</button>

            <button class="status-btn cancel" 
            onclick="cancelOrder('${order.key}','${data.uid}','${data.playerId}',${JSON.stringify(data.package).replace(/"/g,'&quot;')},'${data.price}','${data.payMethod}','${data.time}')">Cancel</button>

            <button class="delete-btn" onclick="deleteOrder('${order.key}')">Delete Order</button>
        `;

        box.appendChild(div);
    });
});

// Normal Status Update
function updateStatus(id,status){
    db.ref("orders/"+id).update({ status });
    alert("Status Updated: " + status);
}

// SUCCESS: Move to user history + remove from admin panel
function markSuccess(id, uid, playerId, packageData, price, payMethod, time){

    const historyData = {
        orderId: id,
        playerId,
        package: packageData,
        price,
        payMethod,
        status: "Success",
        time
    };

    db.ref("users/" + uid + "/orderHistory/" + id).set(historyData);

    db.ref("orders/" + id).remove();

    alert("Order Completed Successfully!");
}

// CANCEL: save rejected + remove from admin
function cancelOrder(id, uid, playerId, packageData, price, payMethod, time){

    const historyData = {
        orderId: id,
        playerId,
        package: packageData,
        price,
        payMethod,
        status: "Rejected",
        time
    };

    db.ref("users/" + uid + "/orderHistory/" + id).set(historyData);

    db.ref("orders/" + id).remove();

    alert("Order Cancelled & Removed from Admin Panel!");
}

// Delete Order
function deleteOrder(id){
    if(confirm("Delete this order?")){
        db.ref("orders/"+id).remove();
        alert("Order Deleted");
    }
}

// Convert Timestamp
function formatDate(t){
    let d = new Date(t);
    return d.toLocaleString();
}
</script>

</body>
</html>