<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Deposit Control</title>

<style>
body{
  background:#0d0d0d;
  color:white;
  font-family:Arial;
  margin:0;
  padding:15px;
}
.container{
  max-width:500px;
  margin:auto;
}

.card{
  background:#151515;
  padding:18px;
  border-radius:12px;
  margin-top:15px;
}

h2{
  text-align:center;
}

input{
  width:100%;
  padding:12px;
  background:#1e1e1e;
  border:1px solid #333;
  color:white;
  border-radius:8px;
  margin-top:5px;
}

button{
  padding:10px 15px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  margin-top:10px;
}

.save-btn{
  width:100%;
  background:#ff006a;
  color:white;
  font-size:17px;
}

.req{
  border-left:4px solid #ff006a;
  padding-left:10px;
  margin-bottom:15px;
}

.approve{
  background:#00c851;
  color:white;
  margin-right:8px;
}

.reject{
  background:#ff4444;
  color:white;
}

.small{
  color:#aaa;
  font-size:13px;
}
</style>
</head>
<body>

<div class="container">

<h2>üíµ Add Money Control</h2>

<!-- PAYMENT NUMBER CONTROL -->
<div class="card">
  <h3>üè¶ Payment Numbers</h3>

  <label>Bkash Number</label>
  <input id="bkash">

  <label>Nagad Number</label>
  <input id="nagad">

  <button class="save-btn" onclick="saveNumbers()">Save Numbers</button>
  <p id="msg"></p>
</div>

<!-- ADD MONEY REQUEST LIST -->
<div class="card">
  <h3>üì© Pending Deposit Requests</h3>
  <div id="requestList">Loading...</div>
</div>

</div>


<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// ---------------- Firebase Config ----------------
const firebaseConfig = {
  apiKey: "AIzaSyBl0PIm4lvZea96Bte3KaKQJvurGE1P8Es",
  authDomain: "post-c7e41.firebaseapp.com",
  projectId: "post-c7e41",
  databaseURL: "https://post-c7e41-default-rtdb.firebaseio.com"
};

firebase.initializeApp(firebaseConfig);

const fs = firebase.firestore();
const rtdb = firebase.database();

const bkashInput = document.getElementById("bkash");
const nagadInput = document.getElementById("nagad");
const msg = document.getElementById("msg");


// ---------- Load Payment Numbers ----------
fs.collection("paymentNumbers").doc("bkash").onSnapshot(d=>{
  if(d.exists){ bkashInput.value = d.data().number; }
});

fs.collection("paymentNumbers").doc("nagad").onSnapshot(d=>{
  if(d.exists){ nagadInput.value = d.data().number; }
});


// ---------- SAVE NUMBERS ----------
function saveNumbers(){
  let bk = bkashInput.value.trim();
  let na = nagadInput.value.trim();

  fs.collection("paymentNumbers").doc("bkash").set({ number: bk });
  fs.collection("paymentNumbers").doc("nagad").set({ number: na })
  .then(()=>{
    msg.innerHTML = "Saved Successfully ‚úîÔ∏è";
  });
}



// ---------- LOAD ADD MONEY REQUESTS ----------
fs.collection("addMoney")
  .where("status", "==", "pending")
  .orderBy("time", "desc")
  .onSnapshot(async snapshot => {

      let html = "";

      for(let doc of snapshot.docs){
        let d = doc.data();

        // Load user info from "users" collection
        let userDoc = await fs.collection("users").doc(d.uid).get();
        let u = userDoc.exists ? userDoc.data() : {};

        // Auto detect phone field (profile phone)
        let profilePhone =
            u.phone ||
            u.number ||
            u.mobile ||
            u.phoneNumber ||
            u.phn ||
            "N/A";

        html += `
        <div class="req">
          <p><b>Name:</b> ${u.name || "N/A"}</p>
          <p><b>Email:</b> ${u.email || "N/A"}</p>
          <p><b>Phone (Profile):</b> ${profilePhone}</p>

          <p><b>Phone (Typed in Add Money Page):</b> ${d.userPhone || "N/A"}</p>

          <p><b>User UID:</b> ${d.uid}</p>
          <p><b>Amount:</b> ${d.amount} Tk</p>
          <p><b>Method:</b> ${d.method}</p>
          <p><b>TxID:</b> ${d.txid}</p>
          <p><b>Sent To Number:</b> ${d.number}</p>

          <p class="small">${d.time ? d.time.toDate() : ""}</p>

          <button class="approve" onclick="approve('${doc.id}', '${d.uid}', ${d.amount})">Approve</button>
          <button class="reject" onclick="rejectReq('${doc.id}')">Reject</button>
        </div>
        `;
      }

      if(snapshot.empty){
        html = "<p>No pending request</p>";
      }

      document.getElementById("requestList").innerHTML = html;

  });



// ---------- APPROVE REQUEST + UPDATE BALANCE ----------
function approve(id, uid, amount){

  fs.collection("addMoney").doc(id).update({
    status: "approved"
  });

  const balanceRef = rtdb.ref("wallet/" + uid + "/dollar");

  balanceRef.once("value").then(snap =>{

      let current = snap.val() || 0;
      let updated = current + amount;

      rtdb.ref("wallet/" + uid).update({
        dollar: updated
      }).then(()=>{

        fs.collection("addMoney").doc(id).update({
          status: "success"
        });

        alert("Deposit Approved & Balance Updated ‚úîÔ∏è");
      });

  });

}



// ---------- REJECT REQUEST ----------
function rejectReq(id){
  fs.collection("addMoney").doc(id).update({
    status: "rejected"
  }).then(()=>{
    alert("Rejected!");
  });
}

</script>

</body>
</html>